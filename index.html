<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZWF Forums</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@2.51.6/dist/full.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body class="bg-base-200">
    <div id="app" class="container mx-auto my-8">
        <div v-if="!user" class="flex justify-center">
            <div class="card bg-base-100 shadow-xl w-full max-w-md">
                <div class="card-body">
                    <h2 class="card-title text-2xl font-bold mb-4 text-center">ZWF Forums</h2>
                    <div v-if="showLoginForm">
                        <div class="form-control mb-4">
                            <label for="loginEmail" class="label">Email</label>
                            <input type="email" id="loginEmail" v-model="loginEmail" class="input input-bordered">
                        </div>
                        <div class="form-control mb-6">
                            <label for="loginPassword" class="label">Password</label>
                            <input type="password" id="loginPassword" v-model="loginPassword" class="input input-bordered">
                        </div>
                        <button @click="login" class="btn btn-primary btn-block">
                            <span class="material-icons">login</span> Login
                        </button>
                        <button @click="loginAnonymously" class="btn btn-ghost btn-block mt-2">
                            <span class="material-icons">person_outline</span> Login as Guest
                        </button>
                    </div>
                    <div v-else>
                        <div class="form-control mb-4">
                            <label for="signupEmail" class="label">Email</label>
                            <input type="email" id="signupEmail" v-model="signupEmail" class="input input-bordered">
                        </div>
                        <div class="form-control mb-6">
                            <label for="signupPassword" class="label">Password</label>
                            <input type="password" id="signupPassword" v-model="signupPassword" class="input input-bordered">
                        </div>
                        <button @click="signup" class="btn btn-success btn-block">
                            <span class="material-icons">person_add</span> Signup
                        </button>
                    </div>
                    <div class="text-center mt-6">
                        <button @click="toggleForm" class="link link-primary">
                            <span class="material-icons">{{ showLoginForm ? 'person_add' : 'login' }}</span> {{ showLoginForm ? 'Switch to Signup' : 'Switch to Login' }}
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div v-else>
            <div class="navbar bg-base-100 shadow-lg mb-6">
                <div class="flex-1">
                    <h1 class="text-2xl font-bold">ZWF</h1>
                </div>
                <div class="flex-none">
                    <button @click="logout" class="btn btn-primary">
                        <span class="material-icons">logout</span> Logout
                    </button>
                </div>
            </div>
             <div class="card bg-base-100 shadow-xl mb-6" v-if="isAdmin">
                <div class="card-body">
                    <h2 class="text-lg font-bold mb-4">Create New Post</h2>
                    <div class="form-control mb-4">
                        <label for="postTitle" class="label">Post Title</label>
                        <input type="text" id="postTitle" v-model="newPostTitle" class="input input-bordered" placeholder="Enter Post Title">
                    </div>
                    <div class="form-control mb-4">
                        <label for="postContent" class="label">Post Content</label>
                        <textarea id="postContent" v-model="newPostContent" class="textarea textarea-bordered" placeholder="Enter Post Content"></textarea>
                    </div>
                    <button @click="addPost" class="btn btn-primary">
                        <span class="material-icons">add</span> Add Post
                    </button>
                </div>
            </div>
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                <h2 class="text-lg font-bold mb-4">Forum Posts</h2>
                    <div v-if="posts.length === 0" class="text-center">No posts yet.</div>
                    <div v-for="post in posts" :key="post.id" class="mb-6 border-b pb-4">
                        <h3 class="text-xl font-semibold">{{ post.title }}</h3>
                        <p class="text-gray-700 mb-2"> {{ post.content }}</p>
                        <p class="text-sm text-gray-500">
                           Posted by: {{ post.authorName }} at {{ new Date(post.timestamp).toLocaleString() }}
                         </p>

                         <div v-if="isAdmin">
                             <button @click="editPost(post.id)" class="btn btn-sm btn-secondary mt-2 mr-2">Edit</button>
                             <button @click="deletePost(post.id)" class="btn btn-sm btn-error mt-2">Delete</button>
                         </div>

                         <div class="mt-4" v-if="!isGuest">
                                <div class="form-control mb-2">
                                    <label for="replyContent" class="label">Reply to Post</label>
                                    <input type="text" id="replyContent" v-model="replyContent" class="input input-bordered" placeholder="Reply to Post">
                                </div>
                             <button @click="addReply(post.id)" class="btn btn-sm btn-primary mb-2">
                                 <span class="material-icons">reply</span> Reply
                             </button>

                         </div>

                            <ul class="ml-4 mt-2">
                            <li v-for="reply in post.replies" :key="reply.id" class="text-gray-600">
                              {{ reply.content}}
                                <p class="text-xs text-gray-500">
                                  Replied by: {{ reply.authorName }} at {{ new Date(reply.timestamp).toLocaleString() }}
                                </p>
                              </li>
                        </ul>
                    </div>
                </div>
            </div>
         <div v-if="isGuest">
             <p class="text-center">Please login to reply to a post.</p>
         </div>
        </div>
    </div>
    <script>
        var firebaseConfig = {
            apiKey: "AIzaSyA-haa3-HOFU9xaZ4OOViuJ5ZaPfhEHrMM",
            authDomain: "zwf-forums.firebaseapp.com",
            databaseURL: "https://zwf-forums-default-rtdb.firebaseio.com/",
            projectId: "zwf-forums",
            storageBucket: "zwf-forums.firebasestorage.app",
            messagingSenderId: "530467664249",
            appId: "1:530467664249:web:4bc68a0e1c1de83b7c7fa8"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        new Vue({
            el: '#app',
            data: {
                user: null,
                isAdmin: false,
                showLoginForm: true,
                loginEmail: '',
                loginPassword: '',
                signupEmail: '',
                signupPassword: '',
                newPostTitle: '',
                newPostContent: '',
                posts: [],
                isGuest: false,
                editingPostId: null,
                replyContent: "",
            },
              computed: {
            },
            methods: {
                login() {
                    auth.signInWithEmailAndPassword(this.loginEmail, this.loginPassword).then(userCredential => {
                        this.user = userCredential.user;
                        this.isGuest = false;
                        this.checkAdmin();
                        this.fetchPosts();
                    });
                },
                checkAdmin() {
                   const adminEmail = "admin@admin.com"; // Admin email address
                    this.isAdmin = this.user.email === adminEmail;
                },
                   loginAnonymously() {
                    auth.signInAnonymously().then(() => {
                        this.user = auth.currentUser;
                        this.isGuest = true;
                        this.fetchPosts();
                    });
                },
                signup() {
                    auth.createUserWithEmailAndPassword(this.signupEmail, this.signupPassword).then(userCredential => {
                        this.user = userCredential.user;
                           this.isGuest = false;
                        this.fetchPosts();
                    });
                },
                toggleForm() {
                    this.showLoginForm = !this.showLoginForm;
                },
                logout() {
                    auth.signOut().then(() => {
                        this.user = null;
                        this.posts = [];
                         this.isGuest = false;
                    });
                },
                 addPost() {
                    if (this.newPostTitle && this.newPostContent) {
                        const postData = {
                            title: this.newPostTitle,
                            content: this.newPostContent,
                            author: this.user.uid,
                            authorName: this.user.email,
                            timestamp: firebase.database.ServerValue.TIMESTAMP,
                            replies: [],
                        };
                            database.ref('posts').push(postData).then(() => {
                            this.newPostTitle = '';
                            this.newPostContent = '';
                            this.fetchPosts();
                        }).catch(error => {
                            console.error("Error adding post: ", error);
                        });
                    } else {
                        alert("Please fill in both title and content.");
                    }
                },
                editPost(postId) {
                   this.editingPostId = postId;
                   const post = this.posts.find(post => post.id === postId);
                    if(post) {
                        this.newPostTitle = post.title;
                        this.newPostContent = post.content;
                         if(confirm("Do you want to edit this post?")){
                           const postData = {
                            title: this.newPostTitle,
                            content: this.newPostContent,
                             author: this.user.uid,
                                  authorName: this.user.email,
                            timestamp: firebase.database.ServerValue.TIMESTAMP
                           };
                            database.ref('posts/' + postId).update(postData).then(() => {
                             this.editingPostId = null;
                             this.newPostTitle = '';
                             this.newPostContent = '';
                              this.fetchPosts();
                           }).catch(error => {
                               console.error("Error editing post:", error);
                           });

                        }
                      }

                },
                deletePost(postId) {
                    if (confirm("Are you sure you want to delete this post?")) {
                        database.ref('posts/' + postId).remove().then(() => {
                            this.fetchPosts();
                        }).catch(error => {
                            console.error("Error deleting post: ", error);
                        });
                    }
                },
                fetchPosts() {
                    database.ref('posts').orderByChild('timestamp').once('value').then(snapshot => {
                        this.posts = [];
                        snapshot.forEach(childSnapshot => {
                            const post = childSnapshot.val();
                            const replies = post.replies ? Object.values(post.replies).sort((a, b) => a.timestamp - b.timestamp) : [];
                            this.posts.push({ id: childSnapshot.key, ...post, replies: replies });
                        });
                    });
                },
                addReply(postId) {
                    if (!this.replyContent){
                        alert('Reply cannot be empty');
                        return;
                    }

                    const replyData = {
                        content: this.replyContent,
                        author: this.user.uid,
                        authorName: this.user.email,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    };

                    database.ref(`posts/${postId}/replies`).push(replyData).then(() => {
                        this.replyContent = "";
                        this.fetchPosts();
                    }).catch(error => {
                        console.error('Error adding reply: ', error);
                    })
                },
            },
            created() {
                auth.onAuthStateChanged(user => {
                    this.user = user;
                   if(user) {
                       this.isGuest = user.isAnonymous;
                        this.checkAdmin();
                        this.fetchPosts();
                    }
                });
            }
        });
    </script>
</body>
</html>